# bot.py

import logging
import asyncio
from telegram import Update, BotCommand
from telegram.ext import Application, CommandHandler, ContextTypes
import config
from handlers.survey import register_survey_handlers
from handlers.tracking import register_tracking_handlers
from handlers.history import register_history_handlers

# 1) Ð’ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ð¾Ðµ DEBUG-Ð»Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.DEBUG
)
logger = logging.getLogger(__name__)

# 2) Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¾ÑˆÐ¸Ð±Ð¾Ðº
async def global_error_handler(update: object, context: ContextTypes.DEFAULT_TYPE):
    logger.error("Exception while handling update:", exc_info=context.error)
    if update and hasattr(update, 'effective_message'):
        await update.effective_message.reply_text(
            "ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ°. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ."
        )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ Ð¿Ñ€Ð¸ ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ /help"""
    help_text = (
        "ðŸ¤– *ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð±Ð¾Ñ‚Ð°:*\n\n"
        "ðŸ”¹ /start - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼\n"
        "ðŸ”¹ /start\_day - ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ\n"
        "ðŸ”¹ /history - ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ñ\n"
        "ðŸ”¹ /analyze\_period - ÐÐ½Ð°Ð»Ð¸Ð· Ð·Ð° Ð¿ÐµÑ€Ð¸Ð¾Ð´\n"
        "ðŸ”¹ /help - ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑÑ‚Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ\n\n"
        "ðŸ“ *Ð’Ð¾ Ð²Ñ€ÐµÐ¼Ñ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð³Ð¾ Ð´Ð½Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾:*\n\n"
        "â€¢ Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ÐµÐ¼Ð¾Ð² Ð¿Ð¸Ñ‰Ð¸\n"
        "â€¢ Ð—Ð°Ð¿Ð¸ÑÑŒ Ñ„Ð¸Ð·Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚Ð¸\n"
        "â€¢ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¹\n"
        "â€¢ ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸\n"
        "â€¢ ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ðµ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹ Ðº Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ñƒ\n\n"
        "â„¹ï¸ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ Ð¼ÐµÐ½ÑŽ Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ð¹ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸"
    )
    await update.message.reply_text(help_text, parse_mode='Markdown')

async def setup_commands(application: Application) -> None:
    """Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÑ‚ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð±Ð¾Ñ‚Ð° Ð² Ð¼ÐµÐ½ÑŽ"""
    commands = [
        BotCommand("start", "ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ñ Ð±Ð¾Ñ‚Ð¾Ð¼"),
        BotCommand("start_day", "ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ"),
        BotCommand("history", "ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ñ"),
        BotCommand("analyze_period", "ÐÐ½Ð°Ð»Ð¸Ð· Ð·Ð° Ð¿ÐµÑ€Ð¸Ð¾Ð´"),
        BotCommand("help", "ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒ")
    ]
    await application.bot.set_my_commands(commands)

def run_bot():
    """Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ Ð±Ð¾Ñ‚Ð°"""
    app = Application.builder().token(config.TELEGRAM_TOKEN).build()
    
    # Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¹ error handler
    app.add_error_handler(global_error_handler)
    
    # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñƒ help
    app.add_handler(CommandHandler("help", help_command))
    
    # Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€ÑƒÐµÐ¼ handlers
    register_survey_handlers(app)
    register_tracking_handlers(app)
    register_history_handlers(app)
    
    # Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð±Ð¾Ñ‚Ð° Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ
    async def post_init(application: Application) -> None:
        await setup_commands(application)
    
    app.post_init = post_init
    
    logger.info("Bot started")
    app.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    run_bot()
